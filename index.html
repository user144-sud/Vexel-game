<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vexel</title>
    <!-- Fonte Pixelada -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Press Start 2P', cursive; touch-action: none; user-select: none; }
        
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .visible { display: flex !important; pointer-events: auto !important; }
        
        #menu-screen { background: #1e3c72; color: white; z-index: 100; }
        h1 { font-size: 28px; text-align: center; line-height: 1.5; text-shadow: 4px 4px 0 #000; margin-bottom: 20px; }
        
        .btn { background: #fff; color: #000; border: 4px solid #000; padding: 12px; font-family: 'Press Start 2P', cursive; font-size: 10px; cursor: pointer; margin: 5px; border-radius: 0; pointer-events: auto; }
        .btn:active { background: #ccc; transform: translateY(2px); }
        .btn-primary { background: #00b894; color: #fff; }

        #custom-screen { background: rgba(0,0,0,0.9); z-index: 110; }
        #custom-container { background: #fff; width: 85%; max-width: 450px; border: 6px solid #000; padding: 15px; color: #000; text-align: center; }
        .row { display: flex; justify-content: center; gap: 5px; margin-bottom: 10px; flex-wrap: wrap; }
        .section-title { font-size: 8px; margin: 10px 0; background: #ddd; padding: 5px; width: 100%; display: block; text-transform: uppercase; }
        .color-btn { width: 25px; height: 25px; border: 2px solid #000; cursor: pointer; }

        #game-ui { pointer-events: none; z-index: 50; }
        #joystick-zone { position: absolute; bottom: 40px; left: 40px; width: 120px; height: 120px; pointer-events: auto; }
        #camera-zone { position: absolute; top: 0; right: 0; width: 50%; height: 100%; z-index: 40; pointer-events: auto; touch-action: none; }
        #btn-menu-small { position: absolute; top: 15px; left: 15px; background: #000; color: #fff; border: 2px solid #fff; padding: 8px; font-size: 8px; pointer-events: auto; cursor: pointer; }
        
        #jump-btn-container { position: absolute; bottom: 40px; right: 40px; pointer-events: auto; z-index: 60; }
        #jump-btn { width: 100px; height: 60px; font-size: 12px; background: #00b894; color: white; border: 4px solid #000; }
    </style>
</head>
<body>

    <!-- Menu Principal -->
    <div id="menu-screen" class="screen visible">
        <h1>VEXEL</h1>
        <button class="btn btn-primary" onclick="startGame()">PLAY GAME</button>
        <button class="btn" onclick="openCustomization()">AVATAR EDITOR</button>
    </div>

    <!-- Editor de Avatar -->
    <div id="custom-screen" class="screen">
        <div id="custom-container">
            <h2 style="font-size: 12px;">EDITOR</h2>
            
            <span class="section-title">Outfits (Roupas)</span>
            <div class="row">
                <button class="btn" style="font-size:8px;" onclick="setOutfit('default')">DEFAULT</button>
                <button class="btn" style="font-size:8px; background:#ff4500; color:#fff;" onclick="setOutfit('magma')">MAGMA</button>
                <button class="btn" style="font-size:8px; background:#333; color:#fff;" onclick="setOutfit('pirate')">PIRATE</button>
            </div>

            <span class="section-title">Accessories</span>
            <div class="row">
                <button class="btn" style="font-size:8px;" onclick="setAccessory('none')">NONE</button>
                <button class="btn" style="font-size:8px;" onclick="setAccessory('hat')">TOP HAT</button>
                <button class="btn" style="font-size:8px;" onclick="setAccessory('glasses')">GLASSES</button>
            </div>

            <span class="section-title">Skin Color</span>
            <div class="row" id="skin-picker"></div>
            
            <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="closeCustomization()">DONE</button>
        </div>
    </div>

    <!-- Interface de Jogo -->
    <div id="game-ui" class="screen">
        <button id="btn-menu-small" onclick="returnToMenu()">MENU</button>
        <div id="joystick-zone"></div>
        <div id="camera-zone"></div>
        <div id="jump-btn-container">
            <button id="jump-btn" class="btn">JUMP</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.9.0/nipplejs.min.js"></script>

    <script>
        // --- TEXTURAS ---
        function createMagmaTexture() {
            const canvas = document.createElement('canvas'); canvas.width = 64; canvas.height = 64;
            const ctx = canvas.getContext('2d');
            for(let x=0; x<64; x+=4) {
                for(let y=0; y<64; y+=4) {
                    ctx.fillStyle = Math.random() > 0.5 ? '#ff4500' : '#330000';
                    ctx.fillRect(x, y, 4, 4);
                }
            }
            return new THREE.CanvasTexture(canvas);
        }
        function createPirateTexture() {
            const canvas = document.createElement('canvas'); canvas.width = 64; canvas.height = 64;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#fff'; ctx.fillRect(0,0,64,64);
            ctx.fillStyle = '#000';
            for(let y=0; y<64; y+=16) ctx.fillRect(0, y, 64, 8);
            return new THREE.CanvasTexture(canvas);
        }
        const magmaTex = createMagmaTexture();
        const pirateTex = createPirateTexture();

        // --- ENGINE ---
        let isGameRunning = false;
        let cameraAngle = Math.PI;
        let touchStartX = 0;
        let velocityY = 0;
        let gravity = -0.015;
        let jumpPower = 0.35;
        let isGrounded = true;

        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB);
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: false });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);
        scene.add(new THREE.AmbientLight(0xffffff, 0.9));

        const ground = new THREE.Mesh(new THREE.PlaneGeometry(300, 300), new THREE.MeshStandardMaterial({ color: 0x555555 }));
        ground.rotation.x = -Math.PI / 2;
        scene.add(ground);
        scene.add(new THREE.GridHelper(300, 60, 0x000, 0x000));

        // --- AVATAR R6 ---
        const player = new THREE.Group();
        scene.add(player);

        const mats = {
            skin: new THREE.MeshStandardMaterial({ color: 0xFFD700 }),
            torso: new THREE.MeshStandardMaterial({ color: 0x0099CC }),
            legs: new THREE.MeshStandardMaterial({ color: 0xA1C45A }),
            black: new THREE.MeshBasicMaterial({ color: 0x000000 })
        };

        const torso = new THREE.Mesh(new THREE.BoxGeometry(1, 1, 0.5), mats.torso);
        torso.position.y = 1.5; player.add(torso);

        const headSize = 0.6;
        const head = new THREE.Mesh(new THREE.BoxGeometry(headSize, headSize, headSize), mats.skin);
        head.position.y = 2.3; player.add(head);

        const eye = new THREE.Mesh(new THREE.BoxGeometry(0.12, 0.05, 0.01), mats.black);
        const lEye = eye.clone(); lEye.position.set(-0.15, 0.05, 0.31); head.add(lEye);
        const rEye = eye.clone(); rEye.position.set(0.15, 0.05, 0.31); head.add(rEye);
        const mouth = new THREE.Mesh(new THREE.BoxGeometry(0.3, 0.05, 0.01), mats.black);
        mouth.position.set(0, -0.15, 0.31); head.add(mouth);

        const accessories = { hat: new THREE.Group(), glasses: new THREE.Group() };
        const brim = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 0.5, 0.05, 8), new THREE.MeshStandardMaterial({color: 0x111}));
        const topPart = new THREE.Mesh(new THREE.CylinderGeometry(0.35, 0.35, 0.4, 8), new THREE.MeshStandardMaterial({color: 0x111}));
        topPart.position.y = 0.2; accessories.hat.add(brim, topPart);
        accessories.hat.position.y = 0.35; accessories.hat.visible = false; head.add(accessories.hat);

        const lensGeo = new THREE.BoxGeometry(0.2, 0.12, 0.05);
        const lLens = new THREE.Mesh(lensGeo, mats.black); lLens.position.set(-0.18, 0.05, 0.32);
        const rLens = lLens.clone(); rLens.position.x = 0.18;
        const bridge = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.03, 0.05), mats.black); bridge.position.set(0, 0.05, 0.32);
        accessories.glasses.add(lLens, rLens, bridge); accessories.glasses.visible = false; head.add(accessories.glasses);

        function createLimb(mat, x, y) {
            const g = new THREE.Group(); g.position.set(x, y, 0);
            const m = new THREE.Mesh(new THREE.BoxGeometry(0.5, 1, 0.5), mat);
            m.position.y = -0.5; g.add(m); player.add(g); return g;
        }
        const lArm = createLimb(mats.skin, -0.75, 2);
        const rArm = createLimb(mats.skin, 0.75, 2);
        const lLeg = createLimb(mats.legs, -0.25, 1);
        const rLeg = createLimb(mats.legs, 0.25, 1);

        // --- FUNÇÕES EDITOR ---
        function setOutfit(type) {
            mats.torso.map = mats.legs.map = null;
            if(type === 'magma') {
                mats.torso.map = mats.legs.map = magmaTex;
                mats.torso.color.set(0xffffff); mats.legs.color.set(0xffffff);
            } else if (type === 'pirate') {
                mats.torso.map = pirateTex;
                mats.torso.color.set(0xffffff); mats.legs.color.set(0x222222);
            } else {
                mats.torso.color.set(0x0099CC); mats.legs.color.set(0xA1C45A);
            }
            mats.torso.needsUpdate = mats.legs.needsUpdate = true;
        }

        function setAccessory(type) {
            accessories.hat.visible = (type === 'hat');
            accessories.glasses.visible = (type === 'glasses');
        }

        const colorPalette = [0xFFD700, 0x0099CC, 0xA1C45A, 0xFFFFFF, 0x000000, 0xCC0000];
        const skinPicker = document.getElementById('skin-picker');
        colorPalette.forEach(col => {
            const b = document.createElement('div'); b.className = 'color-btn';
            b.style.backgroundColor = '#' + new THREE.Color(col).getHexString();
            b.onclick = () => { mats.skin.color.setHex(col); };
            skinPicker.appendChild(b);
        });

        function openCustomization() { document.getElementById('menu-screen').classList.remove('visible'); document.getElementById('custom-screen').classList.add('visible'); }
        function closeCustomization() { document.getElementById('custom-screen').classList.remove('visible'); document.getElementById('menu-screen').classList.add('visible'); }
        function startGame() { document.getElementById('menu-screen').classList.remove('visible'); document.getElementById('game-ui').classList.add('visible'); isGameRunning = true; if(joy) joy.resize(); }
        function returnToMenu() { isGameRunning = false; document.getElementById('game-ui').classList.remove('visible'); document.getElementById('menu-screen').classList.add('visible'); }

        function tryJump() { if(isGrounded && isGameRunning) { velocityY = jumpPower; isGrounded = false; } }
        document.getElementById('jump-btn').addEventListener('touchstart', (e) => { e.preventDefault(); tryJump(); });
        document.getElementById('jump-btn').addEventListener('mousedown', (e) => { tryJump(); });

        // --- CONTROLES ---
        let moveVec = { x: 0, y: 0 };
        const keys = { w:0, a:0, s:0, d:0 };
        const joy = nipplejs.create({ zone: document.getElementById('joystick-zone'), mode: 'static', position: { left: '50%', top: '50%' }, color: 'white' });
        
        joy.on('move', (e, d) => { 
            moveVec.x = d.vector.x; 
            moveVec.y = d.vector.y; // Y do joystick agora sobe (positivo) quando empurrado para frente
        });
        joy.on('end', () => { moveVec.x = 0; moveVec.y = 0; });

        document.getElementById('camera-zone').addEventListener('touchstart', e => touchStartX = e.touches[0].clientX);
        document.getElementById('camera-zone').addEventListener('touchmove', e => { 
            cameraAngle -= (e.touches[0].clientX - touchStartX) * 0.007; 
            touchStartX = e.touches[0].clientX; 
        });

        window.addEventListener('keydown', e => { 
            if(e.code === 'Space') tryJump();
            const k = e.key.toLowerCase(); if(k==='w') keys.w=1; if(k==='s') keys.s=1; if(k==='a') keys.a=1; if(k==='d') keys.d=1; 
        });
        window.addEventListener('keyup', e => { const k = e.key.toLowerCase(); if(k==='w') keys.w=0; if(k==='s') keys.s=0; if(k==='a') keys.a=0; if(k==='d') keys.d=0; });

        // --- LOOP ---
        let walk = 0;
        function animate() {
            requestAnimationFrame(animate);
            if (!isGameRunning) {
                if(document.getElementById('custom-screen').classList.contains('visible')) player.rotation.y += 0.01;
                renderer.render(scene, camera); return;
            }

            // Física de Pulo
            player.position.y += velocityY;
            if(player.position.y > 0) { velocityY += gravity; isGrounded = false; } 
            else { player.position.y = 0; velocityY = 0; isGrounded = true; }

            // CORREÇÃO DO JOYSTICK: 
            // dz (frente/trás) usa o Y do joystick invertido para que "cima" seja -Z (frente) no Three.js
            let dx = keys.d - keys.a + moveVec.x;
            let dz = keys.w - keys.s + moveVec.y; 

            const mag = Math.min(1, Math.sqrt(dx*dx + dz*dz));
            const camX = player.position.x + 10 * Math.sin(cameraAngle);
            const camZ = player.position.z + 10 * Math.cos(cameraAngle);
            camera.position.x += (camX - camera.position.x) * 0.1; camera.position.z += (camZ - camera.position.z) * 0.1;
            camera.position.y = player.position.y + 5; camera.lookAt(player.position.x, player.position.y + 1, player.position.z);

            if(!isGrounded) {
                // ANIMAÇÃO DE PULO (V-SHAPE ARMS)
                lArm.rotation.x = 0; rArm.rotation.x = 0;
                lArm.rotation.z = Math.PI * 0.85; rArm.rotation.z = -Math.PI * 0.85;
                lLeg.rotation.x = 0; rLeg.rotation.x = 0;
            } else if (mag > 0.1) {
                // CAMINHADA
                const target = Math.atan2(dx, dz) + cameraAngle;
                let diff = target - player.rotation.y;
                while(diff > Math.PI) diff -= Math.PI*2; while(diff < -Math.PI) diff += Math.PI*2;
                player.rotation.y += diff * 0.2;
                player.position.x += Math.sin(target) * 0.15 * mag; player.position.z += Math.cos(target) * 0.15 * mag;
                
                walk += 0.2;
                lArm.rotation.x = Math.sin(walk) * 0.8; rArm.rotation.x = -Math.sin(walk) * 0.8;
                lArm.rotation.z = 0; rArm.rotation.z = 0;
                lLeg.rotation.x = -Math.sin(walk) * 0.8; rLeg.rotation.x = Math.sin(walk) * 0.8;
                torso.position.y = 1.5; head.position.y = 2.3;
            } else {
                // IDLE
                let bob = Math.sin(Date.now() * 0.002) * 0.03;
                torso.position.y = 1.5 + bob; head.position.y = 2.3 + bob;
                lArm.rotation.x = 0; rArm.rotation.x = 0; lArm.rotation.z = 0; rArm.rotation.z = 0;
                lLeg.rotation.x = 0; rLeg.rotation.x = 0;
            }
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => { camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });
        animate();
    </script>
</body>
</html>